<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hue Transitions</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
  <style>
    body {
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    .scene-item {
      display: flex;
      align-items: center;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #f8f9fa;
    }
    .scene-name {
      flex: 1;
      font-weight: 500;
    }
    .scene-id {
      flex: 2;
      font-family: monospace;
      font-size: 0.9em;
      color: #666;
      margin: 0 15px;
    }
    .btn-add {
      flex-shrink: 0;
    }
    .alert-info {
      margin-top: 20px;
    }
    .loading {
      text-align: center;
      padding: 40px;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <h3>Available Hue Scenes</h3>
    <p class="text-muted">Select scenes to add to your HomeKit. Each scene will appear as a switch that activates the scene with your configured transition duration.</p>

    <div id="loading" class="loading">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p>Fetching scenes from your Hue bridge...</p>
    </div>

    <div id="error" class="alert alert-danger" style="display:none;"></div>

    <div id="not-configured" class="alert alert-warning" style="display:none;">
      <h5>Bridge Not Configured</h5>
      <p>Please configure your Hue bridge IP address and API key in the plugin settings first.</p>
      <ol>
        <li>Go to the plugin settings</li>
        <li>Enter your bridge IP address (or leave empty for auto-discovery)</li>
        <li>Enter your API key</li>
        <li>Save and return here to select scenes</li>
      </ol>
    </div>

    <div id="scenes-container" style="display:none;">
      <div id="scenes-list"></div>

      <div class="alert alert-info">
        <strong>Tip:</strong> After adding scenes, you can configure the transition duration (1-60 minutes) for each scene in the main plugin configuration.
      </div>
    </div>
  </div>

  <script>
    (async function() {
      const homebridge = window.homebridge;
      const loading = document.getElementById('loading');
      const error = document.getElementById('error');
      const notConfigured = document.getElementById('not-configured');
      const scenesContainer = document.getElementById('scenes-container');
      const scenesList = document.getElementById('scenes-list');

      try {
        // Fetch available scenes from the plugin
        const response = await homebridge.request('/scenes');

        loading.style.display = 'none';

        if (!response || response.length === 0) {
          notConfigured.style.display = 'block';
          return;
        }

        // Get currently configured scenes
        const pluginConfig = await homebridge.getPluginConfig();
        const configuredSceneIds = new Set(
          (pluginConfig[0]?.scenes || []).map(s => s.id)
        );

        scenesContainer.style.display = 'block';

        // Render scene list
        response.forEach(scene => {
          const isConfigured = configuredSceneIds.has(scene.id);

          const sceneItem = document.createElement('div');
          sceneItem.className = 'scene-item';
          sceneItem.innerHTML = `
            <div class="scene-name">${scene.name}</div>
            <div class="scene-id">${scene.id}</div>
            <button
              class="btn btn-sm ${isConfigured ? 'btn-secondary' : 'btn-primary'} btn-add"
              ${isConfigured ? 'disabled' : ''}
              onclick="addScene('${scene.id}', '${scene.name.replace(/'/g, "\\'")}')">
              ${isConfigured ? 'Added' : 'Add Scene'}
            </button>
          `;
          scenesList.appendChild(sceneItem);
        });

      } catch (err) {
        loading.style.display = 'none';
        error.style.display = 'block';
        error.textContent = 'Failed to load scenes: ' + err.message;
        console.error('Error loading scenes:', err);
      }
    })();

    async function addScene(sceneId, sceneName) {
      try {
        const homebridge = window.homebridge;
        const pluginConfig = await homebridge.getPluginConfig();

        // Add new scene to config
        if (!pluginConfig[0].scenes) {
          pluginConfig[0].scenes = [];
        }

        pluginConfig[0].scenes.push({
          id: sceneId,
          name: sceneName,
          transitionDuration: 30 // default 30 minutes
        });

        // Save config
        await homebridge.updatePluginConfig(pluginConfig);

        // Show success and reload
        homebridge.toast.success(`Added "${sceneName}" to configuration`, 'Success');

        // Reload the page to update the UI
        setTimeout(() => window.location.reload(), 1000);

      } catch (err) {
        homebridge.toast.error('Failed to add scene: ' + err.message, 'Error');
        console.error('Error adding scene:', err);
      }
    }
  </script>
</body>
</html>
